# 土地図からの一軒家CAD図自動生成システムの実装計画

## 実装の全体ゴール
土地図をアップロードするだけで、自動的に一軒家のCAD図が生成されるシステムを構築する。FreeCADを組み込み、YOLOv11ベースの建物・道路セグメンテーションシステムを拡張する。

## 実装状況（2024-04-14更新）

### 完了した実装
- ✅ FreeCADのDockerコンテナ化
- ✅ FastAPIベースのFreeCAD APIサービス
- ✅ グリッドデータ処理エンドポイント
- ✅ 2D図面変換エンドポイント
- ✅ 基本的な壁・開口部の描画機能
- ✅ 寸法線生成機能
- ✅ Cloud RunへのFreeCAD APIデプロイ
- ✅ モニタリング設定（エラー率、レイテンシー、メモリ使用量）
- ✅ GKEクラスターの設定
- ✅ Cloud Run Jobsの設定

### 進行中の実装
- 🟡 FreeCADの実際の処理実装
- 🟡 建築基準法チェック機能
- 🟡 建具記号ライブラリ
- 🟡 タイトルブロックテンプレート
- 🟡 StreamlitのGCPクラウドデプロイ
- 🟡 Vertex AI統合の実装
- 🟡 セグメンテーション精度の向上

## 優先実装項目（2024-04-14更新）

### 1. StreamlitのGCPクラウドデプロイ
- Cloud RunへのStreamlitアプリケーションのデプロイ
- ユーザーインターフェースの最適化
- 認証・認可の実装

### 2. FreeCAD APIの完全実装
- 実際のFreeCAD処理の実装
- エラーハンドリングの強化
- パフォーマンス最適化

### 3. Vertex AI統合の実装
- YOLOv8モデルのVertex AIへの移行
- トレーニングパイプラインの構築
- 推論エンドポイントの設定

### 4. セグメンテーション精度の向上
- データセットの拡充
- モデルの再トレーニング
- 評価指標の改善

### 5. 建築基準法チェック機能の実装
- 建蔽率・容積率チェック
- 日影規制チェック
- 高さ制限チェック

## 実装すべき主要コンポーネント

### 1. 土地解析エンジンの拡張

**目的**: YOLOv8による検出結果から、より詳細な土地情報を抽出する

**実装内容**:
- 道路と建物の関係性をより詳細に分析するアルゴリズム
- 土地の向き（方位）を自動検出する機能
- 土地形状から最適な建物配置場所を特定する機能
- 法的制約（建蔽率、容積率など）を考慮した建築可能エリアの計算

### 2. FreeCAD連携インターフェース

**目的**: StreamlitアプリケーションとオープンソースのFreeCAD間のデータ連携を実現

**実装内容**:
- ✅ FreeCADをPythonから制御するためのラッパークラス
- ✅ FreeCADのPythonスクリプト生成機能
- 🟡 実行結果のモニタリングとフィードバック処理
- 🟡 一時ファイルの管理と結果の取り込み

### 3. 建物レイアウト生成エンジン

**目的**: 土地制約から最適な建物形状と間取りを自動的に生成

**実装内容**:
- ✅ 建物外形生成アルゴリズム（日照・通風を考慮）
- 🟡 間取り自動生成ロジック
- ❌ 部屋配置の最適化（動線、採光などを考慮）
- ❌ ドア・窓の適切な配置ロジック

### 4. CAD図面生成モジュール

**目的**: FreeCADを活用して専門的なCAD図面を生成

**実装内容**:
- ✅ FreeCADスクリプトテンプレートの作成
- ✅ 寸法線・注釈の自動追加ロジック
- 🟡 レイヤー管理と整理
- ❌ 建築基準に準拠した図面仕様の実装

### 5. ユーザーインターフェース拡張

**目的**: 現在のStreamlitアプリを拡張し、CAD図面生成機能を統合

**実装内容**:
- ✅ CAD設定のパラメータ入力UI
- 🟡 生成された図面のプレビュー機能
- ❌ DXF/DWGダウンロード機能
- ✅ 進捗表示とエラーハンドリング

## 具体的な実装ステップ

### ステップ1: 環境セットアップ ✅
- ✅ FreeCADをDockerコンテナに組み込む
- ✅ 必要なPythonライブラリのインストール（FreeCAD Python API, ezdxf等）
- ✅ 開発・テスト環境の構築

### ステップ2: 土地解析エンジンの強化 🟡
- ✅ YOLOv8の出力から土地特性（向き、接道状況など）を抽出するロジックの実装
- 🟡 建築可能エリアの計算アルゴリズムの改良
- ✅ テスト用の土地データセットの準備

### ステップ3: FreeCAD連携の基盤実装 ✅
- ✅ FreeCADのheadlessモードでの実行
- ✅ Pythonスクリプト生成・実行のフレームワーク作成
- ✅ 基本的な図形（矩形、線）の生成テスト

### ステップ4: 建物レイアウトの自動生成 🟡
- ✅ 建物外形の最適化アルゴリズム実装
- 🟡 必要な部屋タイプと最小面積の定義
- 🟡 間取り配置ロジックの実装
- 🟡 壁・開口部の自動配置

### ステップ5: CAD図面生成の実装 🟡
- ✅ FreeCADによる2D図面生成
- ✅ 寸法線・注釈の追加機能
- 🟡 標準的な建築CAD図面のテンプレート作成
- ❌ DXF/DWGエクスポート機能

### ステップ6: UI統合とテスト 🟡
- ✅ Streamlitインターフェースの拡張
- 🟡 プレビュー・ダウンロード機能の実装
- ✅ エラーハンドリングとログ機能強化
- 🟡 ユーザーテストとフィードバック収集

### ステップ7: 最適化と品質向上 ❌
- ❌ パフォーマンス改善
- ❌ 出力CAD図の品質チェック
- ❌ エッジケースへの対応
- ❌ ユーザーフィードバックに基づく改良

## 検討すべき技術的課題

1. **FreeCADの自動化**: ✅ ヘッドレスモードでのFreeCAD実行と安定性の確保
2. **計算効率**: 🟡 建物最適化・間取り生成の計算負荷への対応
3. **CADデータ品質**: 🟡 専門家が利用できる品質のCAD図面生成
4. **汎用性**: 🟡 様々な土地形状や要件に対応できる柔軟性の確保
5. **拡張性**: ✅ 将来的な3Dモデリングや詳細設計への対応準備

## 次のステップ

1. FreeCAD APIの実際の処理実装を完了させる
2. 建築基準法チェック機能の実装を開始する
3. 建具記号ライブラリの作成を進める
4. タイトルブロックテンプレートの設計を行う

この実装計画に基づいて進めることで、土地図から一軒家のCAD図を自動生成する革新的なシステムを構築できるでしょう。
