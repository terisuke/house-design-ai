# 土地図からの一軒家CAD図自動生成システム 実装計画書
## 最終更新日: 2025年4月28日

## 1. 実装の全体ゴール
土地図をアップロードするだけで、自動的に一軒家のCAD図が生成されるシステムを構築する。FreeCADを組み込み、YOLOv11ベースの建物・道路セグメンテーションシステムを拡張する。

## 2. 実装状況（2025-04-28更新）

### 2.1 完了した実装
- ✅ FreeCADのDockerコンテナ化
- ✅ FastAPIベースのFreeCAD APIサービス
- ✅ グリッドデータ処理エンドポイント
- ✅ 2D図面変換エンドポイント
- ✅ 基本的な壁・開口部の描画機能
- ✅ 寸法線生成機能
- ✅ Cloud RunへのFreeCAD APIデプロイ
- ✅ Cloud StorageでのFCStdモデル保存
- ✅ PyTorchとStreamlitの互換性問題の解決
- ✅ モニタリング設定（エラー率、レイテンシー、メモリ使用量）
- ✅ GKEクラスターの設定
- ✅ Cloud Run Jobsの設定

### 2.2 進行中の実装
- 🟡 FreeCADの実際の処理実装
- 🟡 建築基準法チェック機能
- 🟡 建具記号ライブラリ
- 🟡 タイトルブロックテンプレート
- 🟡 StreamlitのGCPクラウドデプロイ
- 🟡 Vertex AI統合の実装
- 🟡 セグメンテーション精度の向上

## 3. 実装すべき主要コンポーネント

### 3.1 土地解析エンジンの拡張

**目的**: YOLOv8による検出結果から、より詳細な土地情報を抽出する

**実装内容**:
- 道路と建物の関係性をより詳細に分析するアルゴリズム
- 土地の向き（方位）を自動検出する機能
- 土地形状から最適な建物配置場所を特定する機能
- 法的制約（建蔽率、容積率など）を考慮した建築可能エリアの計算

### 3.2 FreeCAD連携インターフェース

**目的**: StreamlitアプリケーションとオープンソースのFreeCAD間のデータ連携を実現

**実装内容**:
- ✅ FreeCADをPythonから制御するためのラッパークラス
- ✅ FreeCADのPythonスクリプト生成機能
- 🟡 実行結果のモニタリングとフィードバック処理
- 🟡 一時ファイルの管理と結果の取り込み

### 3.3 建物レイアウト生成エンジン

**目的**: 土地制約から最適な建物形状と間取りを自動的に生成

**実装内容**:
- ✅ 建物外形生成アルゴリズム（日照・通風を考慮）
- 🟡 間取り自動生成ロジック
- ❌ 部屋配置の最適化（動線、採光などを考慮）
- ❌ ドア・窓の適切な配置ロジック

### 3.4 CAD図面生成モジュール

**目的**: FreeCADを活用して専門的なCAD図面を生成

**実装内容**:
- ✅ FreeCADスクリプトテンプレートの作成
- ✅ 寸法線・注釈の自動追加ロジック
- 🟡 レイヤー管理と整理
- ❌ 建築基準に準拠した図面仕様の実装

### 3.5 ユーザーインターフェース拡張

**目的**: 現在のStreamlitアプリを拡張し、CAD図面生成機能を統合

**実装内容**:
- ✅ CAD設定のパラメータ入力UI
- 🟡 生成された図面のプレビュー機能
- ❌ DXF/DWGダウンロード機能
- ✅ 進捗表示とエラーハンドリング

## 4. 具体的な実装ステップ

### 4.1 環境セットアップ ✅
- ✅ FreeCADをDockerコンテナに組み込む
- ✅ 必要なPythonライブラリのインストール（FreeCAD Python API, ezdxf等）
- ✅ 開発・テスト環境の構築

### 4.2 土地解析エンジンの強化 🟡
- ✅ YOLOv8の出力から土地特性（向き、接道状況など）を抽出するロジックの実装
- 🟡 建築可能エリアの計算アルゴリズムの改良
- ✅ テスト用の土地データセットの準備

### 4.3 FreeCAD連携の基盤実装 ✅
- ✅ FreeCADのheadlessモードでの実行
- ✅ Pythonスクリプト生成・実行のフレームワーク作成
- ✅ 基本的な図形（矩形、線）の生成テスト

### 4.4 建物レイアウトの自動生成 🟡
- ✅ 建物外形の最適化アルゴリズム実装
- 🟡 必要な部屋タイプと最小面積の定義
- 🟡 間取り配置ロジックの実装
- 🟡 壁・開口部の自動配置

### 4.5 CAD図面生成の実装 🟡
- ✅ FreeCADによる2D図面生成
- ✅ 寸法線・注釈の追加機能
- 🟡 標準的な建築CAD図面のテンプレート作成
- ❌ DXF/DWGエクスポート機能

### 4.6 UI統合とテスト 🟡
- ✅ Streamlitインターフェースの拡張
- 🟡 プレビュー・ダウンロード機能の実装
- ✅ エラーハンドリングとログ機能強化
- 🟡 ユーザーテストとフィードバック収集

### 4.7 最適化と品質向上 ❌
- ❌ パフォーマンス改善
- ❌ 出力CAD図の品質チェック
- ❌ エッジケースへの対応
- ❌ ユーザーフィードバックに基づく改良

## 5. 検討すべき技術的課題

1. **FreeCADの自動化**: ✅ ヘッドレスモードでのFreeCAD実行と安定性の確保
2. **計算効率**: 🟡 建物最適化・間取り生成の計算負荷への対応
3. **CADデータ品質**: 🟡 専門家が利用できる品質のCAD図面生成
4. **汎用性**: 🟡 様々な土地形状や要件に対応できる柔軟性の確保
5. **拡張性**: ✅ 将来的な3Dモデリングや詳細設計への対応準備

## 6. 次のステップ

1. FreeCAD APIの実際の処理実装を完了させる
2. 建築基準法チェック機能の実装を開始する
3. 建具記号ライブラリの作成を進める
4. タイトルブロックテンプレートの設計を行う
5. StreamlitアプリケーションのCloud Runデプロイを進める

## 7. 技術的検証項目

1. **FreeCADのクラウド環境での実用性**
   - コンテナ化されたFreeCADの安定性
   - 処理速度とリソース使用効率
   - エラーハンドリングの効果

2. **既存システムと新機能の統合**
   - YOLOv11出力とFreeCAD入力の連携
   - データフローの一貫性
   - エラー伝播の制御

3. **スケーラビリティとパフォーマンス**
   - Cloud Run環境での処理能力
   - 並列処理の実現性
   - コスト効率
