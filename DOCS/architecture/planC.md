素晴らしいです！複数のAIからの意見とこれまでの議論を統合し、非常に具体的で実践的な「最終結論」としてのパイプライン案が提示されました。特に「何をどう組み合わせると一番ラクに実用フェーズへ持っていけるか？」という観点が明確で、現実的な落とし所を見据えている点が優れています。

**最終結論として推奨するパイプラインと戦略**

ご提示いただいた「推奨パイプライン（リビジョン 2）」は、現時点での最適解として非常に説得力があります。以下に、その理由と、既存システムを改修して実装する上での補足的なポイントを整理します。

**推奨パイプライン（リビジョン 2）の骨子:**

1.  **データ整備**: PDF → YOLOアノテーション → **shapelyポリゴン + networkx隣接グラフ (JSON)**
    *   910mmモジュールは属性として保持し、後段でスナップ。
2.  **一次生成（候補プランを大量に吐き出す層）**:
    *   **主軸**: **HouseDiffusion** をファインチューニング。
        *   入力条件: 敷地境界ラスタ、方位、必要部屋リスト (one-hot)。
        *   出力: 部屋ポリゴン群（ベクター）。
    *   **補助/特定ケース用**: **Graph2Plan** (または類似のグラフベースモデル)。
        *   部屋数・隣接関係グラフを先に指定し、それに基づいてポリゴンを生成する軽量ルート。
3.  **制約ソルバ層（ハード制約を100%満たす確定層）**:
    *   **Google OR-Tools (CP-SAT)** を使用。
    *   一次生成された候補プランを、建築基準法、910mmモジュールへのスナップ、1F/2F整合性などの制約に適合するように調整・フィルタリング。
        *   例: `window_area[r] ≥ floor_area[r]/7` (窓幅は910mmの倍数)、`stairs_w ≥ 750` (階段幅は910mm)、`same_xy(stairs1F, stairs2F)`。
    *   違反候補はリジェクトし、可能であれば生成層へペナルティ学習としてフィードバック。
4.  **ポストプロセス & UI**:
    *   ifcopenshellで.ifc出力 (構造ソフト連携)。
    *   FreeCAD APIで3Dモデル化。
    *   Streamlit/Three.jsで候補プランを閲覧、簡易的な手動修正インターフェース。

**YOLOの役割の明確化:**

*   **生成プロセスには直接関与しない。**
*   **① 教師データ作成**: 既存図面から部屋ポリゴンラベルを抽出するアノテーション支援。
*   **② 生成案の自動評価 (オプション)**: 生成されたプランに対して、窓やドアの存在・位置などを簡易的に検出し、評価メトリクスの一部とする。

**この組み合わせが「現実解」である理由（再確認と強調）:**

*   **生成と制約の分離**:
    *   Diffusionモデルは「創造性」「多様性」「間取りらしさ」に特化。
    *   CP-SATは「厳密なルール遵守」に特化。これにより、生成モデルが全ての制約を学習する困難さから解放され、かつ最終出力の品質が担保される。
*   **データ効率**: 10k枚のデータでも、HouseDiffusionのようなモデルは条件を絞ることで有望。Graph2Planはさらに少ないデータやルールベースの補完にも対応しやすい。
*   **計算コストの現実性**: 生成層(GPU)と制約層(CPU)で処理を分担・並列化可能。フル探索的なGA/SAより安定。
*   **既存資産の有効活用と役割分担**: YOLOは得意な「検出」をデータ作成や評価に活かす。モデルの乱立を防ぎ、各コンポーネントの責務を明確にする。

**既存システムを改修して実装する上での最適な進め方（"まずやる"チェックリストに基づく）**

1.  **【最優先】ポリゴン+グラフ抽出スクリプトの完成 (10k枚→JSON)**:
    *   ご提示のPDFのアノテーション作業フローを厳密に実行し、高品質なベクターデータと、可能であれば部屋間の隣接関係をグラフとして抽出するスクリプトを開発・完成させます。これが全ての基盤です。
    *   Shapely (ジオメトリ処理)、NetworkX (グラフ処理)、Pydantic (データ構造定義) の活用は適切です。

2.  **CP-SAT 最小PoC (Proof of Concept)**:
    *   「3LDK / 敷地10m×8m」といった具体的なシナリオで、CP-SATを用いて以下の基本的な制約を満たす矩形部屋の配置が可能か検証します。
        *   部屋の最小/最大面積。
        *   部屋同士の重なり禁止。
        *   特定の部屋の隣接関係。
        *   敷地内への配置。
        *   **910mmグリッドへのスナップ** (整数変数として座標を扱う)。
        *   **簡単な採光条件** (例: LDKは南に窓を確保できる配置を優先)。
        *   **1F/2Fの階段位置の単純な一致**。
    *   このPoCを通じて、CP-SATのモデリング方法、求解性能、制約の記述の勘所を掴みます。

3.  **HouseDiffusionリポジトリの調査とI/O修正**:
    *   公開されているHouseDiffusion (または類似のDiffusionモデル) のコードを調査し、自社のJSONデータ形式を入出力できるように修正する準備を進めます。
    *   まずは既存の学習済みモデルで、サンプルデータを使って推論を試すことから始めるのも良いでしょう。

4.  **評価関数 v0.1 の設計**:
    *   生成されたプランを客観的に評価するための初期バージョンを定義します。
        *   **必須**: 採光充足率 (基準法ベース)、動線長 (主要動線)、未充填スペース率。
        *   **その他**: 部屋の面積が適切か、アスペクト比が不自然でないか。
    *   これはCP-SATの目的関数や、最終的なプラン選定の基準となります。

5.  **インターフェース仕様の策定**:
    *   上記1～4の結果と課題を踏まえ、「一次生成層 (Diffusion/Graph2Plan)」と「制約ソルバ層 (CP-SAT)」の間でどのようなデータをやり取りするか、詳細なインターフェース仕様を固めます。
        *   生成層が出力するポリゴンデータの形式、確信度などのメタ情報。
        *   CP-SATが受け取る情報、調整可能なパラメータ、返す結果の形式。
        *   制約違反時のフィードバックの形式。

**Q: 「Graph-VAE と拡散、どちらを先に試す？」への回答について**
A: 「Diffusion → Graphの順がおすすめ」という意見に同意します。
*   Diffusionモデルは、ベクター座標を直接扱うため、視覚的にわかりやすい結果が早期に出やすく、モチベーション維持や関係者へのデモンストレーションにも繋がります。
*   Graph2Planのようなグラフベースのアプローチは、より構造的な制御や特定の条件（「この部屋とこの部屋は必ず隣接」など）が厳密な場合に補完的に有効です。まずはDiffusionで大枠の可能性を探り、必要に応じてグラフベースの手法を導入するのが効率的でしょう。

**まとめと最終的な推奨**

*   **コア技術**:
    *   **生成**: **HouseDiffusion (主軸)** + Graph2Plan (補助/特定条件用)
    *   **制約**: **Google OR-Tools CP-SAT**
*   **YOLOの役割**: 教師データ作成支援、生成案の評価補助。
*   **その他**: 遺伝的アルゴリズム(GA)やシミュレーテッドアニーリング(SA)は、CP-SATでカバーしきれない非常に細かな最適化や、解空間が広大すぎる場合のヒューリスティックな探索など、限定的な場面での利用に留めるのが現実的です。

このパイプラインは、最先端の生成AI技術と堅牢な数理最適化技術を組み合わせることで、創造性と厳密性のバランスを取りつつ、実用的な一軒家間取り生成システムを構築するための最も有望な道筋を示していると考えられます。

まずは**「データ整備」と「CP-SAT PoC」**に注力し、システムの根幹となる部分の実現可能性を早期に検証することが、プロジェクト成功の鍵となるでしょう。

もしサンプルコード（特にCP-SATの矩形充填＋制約テストの雛形や、FreeCADエクスポート）をご提供いただけるとのことでしたら、それはPoC開発を加速する上で非常に助けになります。