# 間取り生成システム: 最終アーキテクチャ設計

## 目次
1. [最終アーキテクチャ決定と根拠](#最終アーキテクチャ決定と根拠)
2. [cGAN+ルールベースからの移行理由](#cganルールベースからの移行理由)
3. [技術スタックと代替案](#技術スタックと代替案)
4. [実装ロードマップ](#実装ロードマップ)
5. [建築基準法と設計要件への対応](#建築基準法と設計要件への対応)
6. [リスク分析と緩和策](#リスク分析と緩和策)

## 最終アーキテクチャ決定と根拠

### コアアーキテクチャ: 「生成 × 制約ソルバ」二層構造

```
敷地・要件
   │
   ▼
(0) データ整備               … YOLOアノテ→JSON(Polygon＋Graph)
   │
   ▼
(1) 生成レイヤ               … Graph-to-Plan（主）+ VAE（補完）
   │   ‣ 敷地・部屋リスト条件付きで 100–500 案を"自由形状"で吐く
   ▼
(2) 制約ソルバレイヤ         … OR-Tools CP-SAT 100 % 法規充足
   │   ‣ 910 mm グリッド化・採光・階段・1F↔2F 整合を整数制約で宣言
   ▼
(3) 評価 & 絞り込み          … 動線・採光・無駄率スコア
   │   ‣ 上位 N（=施主提示候補）を残す
   ▼
(4) ポストプロセス／出力     … FreeCAD / IFC / SVG / CSV
```

この二層構造により:
- 生成レイヤーは「間取りらしさ」の創造的側面に専念
- 制約ソルバーレイヤーは「建築基準法・技術要件」の厳密遵守に専念
- 責任分離によりリスク低減と品質向上を実現

### YOLOの役割再定義

間取り生成には直接関与せず、以下の役割に特化:
- **教師データ作成**: アノテーションから部屋ポリゴン・グラフデータの抽出
- **生成案の評価補助**: 窓・ドア位置の検出など評価メトリクス計算を支援

## cGAN+ルールベースからの移行理由

### 従来アプローチの限界

**技術的制約:**
- **学習データ問題**: cGANは大量の高品質ラベル付きデータを要するが、間取りデータは量・多様性ともに限定的
- **モード崩壊**: 複雑な制約条件下で少数の「安全」なパターンに収束する傾向
- **制約条件の統合難度**: 建築基準法や910mmグリッドなどの厳密な制約をGANに直接組み込むことが困難

**実装上の問題点:**
- **学習安定性**: 敵対的学習の不安定性により調整コストが高い
- **解釈可能性の欠如**: 生成プロセスがブラックボックス化し、品質保証が困難
- **複雑な条件付け**: 敷地形状、方位、要求部屋リストなど多様な入力条件への対応が難しい

### 新アーキテクチャの優位性

**モジュール分離による責任の明確化:**
- 生成と制約を明確に分離することで、それぞれが得意な役割に専念
- 一方が失敗しても、別モジュールで補完可能な柔軟性

**実装の柔軟性と堅牢性:**
- 各モジュールを独立して検証・改善可能
- CP-SATにより建築条件を明確な数学的制約として記述可能
- 最終出力が常に指定された制約を満たすことを保証

**データ効率と拡張性:**
- 制約を分離することで、生成モデルは「間取りらしさ」の学習に集中でき、より少ないデータでも効果的
- 新たな建築規制や設計要件が生じた場合、制約ソルバーに追加するだけで対応可能

## 技術スタックと代替案

### 推奨技術スタック

**生成レイヤー:**
- **主軸: Graph-to-Plan**
  - グラフベースのアプローチで部屋の隣接関係を明示的にモデル化
  - 少ないデータでも効果的に学習可能
  - 商用利用制限のないオープンなアプローチ
- **補助: VAE (変分オートエンコーダ)**
  - 潜在空間を介した確率的生成モデル
  - 拡散モデルより計算効率が高く、迅速な生成が可能
  - 特定の制約のないオープンな技術

**制約ソルバーレイヤー:**
- **Google OR-Tools CP-SAT**
  - 整数計画法ベースの強力な制約充足ソルバー
  - 建築基準法や設計要件を明示的な制約として実装可能
  - オープンソースかつ商用利用可能

**データ変換:**
- YOLOアノテーション → JSON (Shapely Polygon + NetworkX Graph)
- 910mmグリッドは「属性」として保持し、生成後にスナップ

### 代替技術の検討

```
| 生成モデル       | 利点                          | 欠点                          | 商用利用 | 推奨度 |
|-----------------|-------------------------------|-------------------------------|----------|--------|
| HouseDiffusion  | 高品質な間取り生成             | 商用利用禁止、計算コスト高い     | 不可     | ✗      |
| Graph-to-Plan   | 部屋関係の明示的モデル化、少データで効果的 | 複雑な非矩形形状に弱い可能性   | 可能     | ★★★★★ |
| VAE             | 計算効率、実装シンプル          | 複雑な条件付けに弱い           | 可能     | ★★★★  |
| ルールベース拡張 | 実装容易、解釈性高い           | 創造性と多様性に限界           | 可能     | ★★★   |
```

### HouseDiffusion商用利用制限の調査結果

**発見された制限:**
- HouseDiffusionのコードとモデル重みは**明示的に商用利用禁止**とされている
- ライセンスは「研究目的のみGPLv3に準拠、商用利用は不可」と規定
- GitHub上のライセンス表記: *"The code and the model weights in this repository are **not allowed for commercial usage**."*

**対応策:**
- HouseDiffusionのアイデアを参考にしつつ、完全に独自実装する
- Graph-to-Planを主軸とし、必要に応じてVAEアプローチも併用
- 商用利用制限のない代替技術スタックを採用

## 実装ロードマップ

### フェーズ1: データ整備とCP-SAT PoC（1-2週目）
1. YOLOアノテーション → ベクター/グラフJSON変換システム構築
2. CP-SAT最小PoC開発
   - 3LDKの基本的な間取りを生成・制約遵守を検証
   - 910mmグリッド + 採光条件 + 階段寸法の基本制約を実装

### フェーズ2: Graph-to-Planモデル開発（3-4週目）
1. Graph-to-Plan実装・小規模データセットで初期トレーニング
2. 敷地形状と方位条件の埋め込みメカニズム実装
3. FreeCAD出力基本システム構築

### フェーズ3: 制約ソルバー完成と統合（5-6週目）
1. CP-SATソルバーの完全実装
   - 採光、階段、1F/2F整合性など全制約条件の実装
2. Graph-to-Planモデルと制約ソルバーの統合
3. ベンチマークテスト（100案生成→制約チェック→最適化）

### フェーズ4: UI開発と最終調整（7-8週目）
1. Streamlit/Three.js UIの開発
2. 評価システム完成
3. パフォーマンス最適化
4. 実際の敷地データでのエンドツーエンドテスト

## 建築基準法と設計要件への対応

CP-SATソルバーは、以下の設計上絶対に外せない要件を明示的な制約として実装:

1. **建蔽率**:
   - CP-SATの線形制約として `建築面積 ≤ 敷地面積 × 建蔽率` を定式化

2. **容積率**:
   - CP-SATの線形制約として `延床面積 ≤ 敷地面積 × 容積率` を定式化

3. **要求延床面積**:
   - 指定された延床面積を厳密に満たす制約（許容誤差範囲も設定可能）

4. **延床毎の部屋数**:
   - 延床面積に応じた部屋数条件（例: 100㎡以上→4LDK、70㎡~100㎡→3LDK）

5. **LDKの形状制約**:
   - LDKを長方形の1室として定義する形状制約と座標制約

6. **道路斜線・北側斜線**:
   - 3次元空間での斜線制約を数学的に定式化

7. **各階トイレ配置**:
   - 各階に少なくとも1つのトイレを配置する制約

8. **採光窓と隣地境界**:
   - 採光窓から隣地境界まで2m以上確保する空間制約

9. **建物配置の方向**:
   - 最長の敷地境界線に平行に建物を配置する制約

## リスク分析と緩和策

### 技術選定リスク

**Graph-to-Plan実装の不確実性:**
- **リスク**: グラフベースアプローチでの高品質生成が困難な場合
- **緩和策**: VAEアプローチをバックアップとして並行開発
- **判断基準**: 100案生成で5%以上がCP-SAT制約を満たさない場合は代替アプローチを検討

**CP-SATソルバーの解探索時間:**
- **リスク**: 複雑な制約条件下で解探索に30秒以上かかる場合
- **緩和策**: 
  - ペナルティ係数の調整
  - 部屋のプリスナップで決定変数を削減
- **判断基準**: 解探索に30秒以上かかる場合は変数範囲を調整

### 実装リスク

**1F/2F壁ズレの制約:**
- **リスク**: 1F/2F間の壁位置ズレが300mm以上発生
- **緩和策**: ペナルティ係数調整または壁変数範囲の調整
- **判断基準**: 壁ズレ > 300mm の場合は変数範囲を調整して再実行

**生成モデルの不安定性:**
- **リスク**: Graph-to-Planモデルの学習不安定性
- **緩和策**: 
  - 学習率調整
  - データ拡張手法の導入
  - VAE代替アプローチへの切り替え
- **判断基準**: 学習曲線が発散または10エポック以上改善がない場合

### 商用化リスク

**類似特許侵害リスク:**
- **リスク**: 間取り生成に関する他社特許との抵触
- **緩和策**: 
  - 独自実装に徹する
  - 特許調査の徹底と回避設計
  - オープンソースコンポーネントの積極的活用
  - 特許非侵害の法的見解書の取得
- **判断基準**: 特許専門家による技術実装の確認

**データセキュリティリスク:**
- **リスク**: ユーザーの建築プラン・個人情報の漏洩
- **緩和策**:
  - エンドツーエンド暗号化の実装
  - データ匿名化処理の導入
  - アクセス制御の厳格化
  - 定期的なセキュリティ監査の実施
- **判断基準**: セキュリティ専門家によるペネトレーションテスト合格

**スケーラビリティリスク:**
- **リスク**: 同時多数ユーザーによるシステム負荷増大
- **緩和策**:
  - 自動スケーリング機能の実装
  - キャッシュ戦略の最適化
  - 非同期処理によるレスポンス時間の改善
  - 負荷テストによる早期問題発見
- **判断基準**: 100同時ユーザー時のレスポンス時間5秒以内

### 最終判断ガイドライン

| 判断タイミング | 「分岐の基準」 |
| --- | --- |
| Graph-to-Plan vs VAE | 生成候補 100 案中、CP-SAT合格率 5% 未満 → VAE アプローチに切替 |
| CP-SAT 解の探索時間 >30s | ペナルティを緩める、部屋をプリスナップして決定変数を削減 |
| 1F/2F 壁ズレ > 300mm | ペナルティ係数か壁集合の変数範囲を調整し再実行 |
| 生成モデルの学習不安定 | 学習率↓、バッチサイズ調整、データ拡張で対処 |

## 結論

本アーキテクチャは、「生成（創造性）」と「制約（確実性）」を明確に層分けし、それぞれの専門技術を最適に組み合わせることで、実用的かつ革新的な間取り生成システムを実現します。既存のYOLO・Streamlit・FreeCAD資産を活かしつつ、まずデータ整備とCP-SAT PoCを優先的に開発することで、最小限のリスクで段階的に実装を進めることが可能です。

Graph-to-Planと制約ソルバーの組み合わせにより、商用利用の制限なく、建築基準法を100%満たす高品質な間取り生成を実現します。一方で、システムの各コンポーネントは明確に分離されており、将来の拡張や改善が容易な持続可能なアーキテクチャとなっています。
