# YOLOアノテーション → ベクター/グラフJSON変換システム

## 概要

YOLOアノテーション → ベクター/グラフJSON変換システムは、YOLOモデルによって生成されたアノテーションデータを、間取り図生成に必要なベクターデータおよびグラフ構造のJSONに変換するシステムです。このシステムは、Plan Bアーキテクチャの重要なコンポーネントとして、データ準備段階で使用されます。

## 主要機能

1. **YOLOアノテーションの読み込み**: YOLOフォーマットのアノテーションファイルを読み込み、解析します。
2. **マスク画像への変換**: アノテーションデータをマスク画像に変換します。
3. **輪郭抽出**: OpenCVのcontour detection機能を使用して、マスク画像から輪郭を抽出します。
4. **Shapelyポリゴンへの変換**: 抽出された輪郭をShapelyポリゴンに変換します。
5. **隣接関係の抽出**: ポリゴン間の隣接関係を抽出し、NetworkXグラフとして表現します。
6. **Pydanticモデルへの変換**: ポリゴンとグラフデータをPydanticモデルに変換します。
7. **JSON形式でのシリアライズ**: データをJSON形式でシリアライズして保存します。
8. **視覚化**: 変換結果を視覚化して検証します。

## データ構造

システムは以下のPydanticモデルを使用してデータを構造化します：

- **Point**: x, y座標を持つ点
- **Line**: 始点と終点、タイプ（壁、窓、ドアなど）を持つ線分
- **Room**: ID、名前、点のリスト、面積、隣接する部屋のリスト、部屋タイプを持つ部屋
- **Building**: 部屋、壁、窓、ドアのリストを持つ建物
- **Site**: 建物、敷地境界、道路アクセス、北方向を持つ敷地

## 変換パイプライン

1. **YOLOアノテーション → マスク画像**:
   - YOLOの検出結果（クラスID、中心座標、幅、高さ）をマスク画像に変換
   - 各クラスに対して別々のマスクを生成

2. **マスク画像 → 輪郭**:
   - OpenCVのcontour detection機能を使用
   - 輪郭の階層構造を考慮

3. **輪郭 → Shapelyポリゴン**:
   - 輪郭の点列をShapelyポリゴンに変換
   - ポリゴンの単純化と正規化

4. **ポリゴン → 隣接グラフ**:
   - ポリゴン間の隣接関係を検出
   - NetworkXグラフとして表現

5. **グラフ → Pydanticモデル**:
   - グラフデータをPydanticモデルに変換
   - 部屋、壁、敷地境界などの情報を構造化

6. **Pydanticモデル → JSON**:
   - モデルをJSON形式でシリアライズ
   - スキーマに準拠したフォーマットで保存

## 使用方法

```python
from src.processing.yolo_to_vector import convert_yolo_to_vector, serialize_to_json

# YOLOアノテーションからベクターデータに変換
site = convert_yolo_to_vector(
    annotations_path="path/to/annotations.txt",
    image_width=640,
    image_height=480
)

# JSON形式で保存
serialize_to_json(site, output_path="path/to/output.json")

# 視覚化
from src.processing.yolo_to_vector import visualize_vector_data
visualize_vector_data(site, output_path="path/to/visualization.png")
```

## 性能指標

- **変換精度**: YOLOの検出結果から正確なベクターデータへの変換率 > 95%
- **スキーマ準拠**: 生成されたJSONが定義されたスキーマに100%準拠
- **処理速度**: 処理時間 < 2秒/画像

## テスト

システムの信頼性を確保するために、以下のテストが実装されています：

1. **単体テスト**: 各関数の入出力と境界条件のテスト
2. **統合テスト**: YOLOの出力から最終JSONまでの一連の処理のテスト
3. **視覚的検証**: 変換結果を視覚化して人間が確認

## 実装状況

- ✅ データ構造の定義
- ✅ YOLOアノテーションの読み込み
- ✅ マスク画像への変換
- ✅ 輪郭抽出
- ✅ Shapelyポリゴンへの変換
- ✅ 隣接関係の抽出
- ✅ Pydanticモデルへの変換
- ✅ JSON形式でのシリアライズ
- ✅ 視覚化機能

## 今後の改善点

- パフォーマンスの最適化
- より複雑な建物構造のサポート
- 3Dモデル生成との統合
- ユーザーインターフェースの改善
