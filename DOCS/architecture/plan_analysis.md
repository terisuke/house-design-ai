# 間取り生成システム: 実装プラン分析

## 3つのプラン比較分析

### 共通点

3つのプランは以下の共通した基本アプローチを提案しています：

1. **二層アーキテクチャ**:
   - 生成レイヤー: 多様な間取り案を創造的に生成
   - 制約ソルバーレイヤー: 建築基準法や910mmグリッド要件を厳密に適用

2. **推奨技術スタック**:
   - 生成: HouseDiffusion（主）、Graph2Plan（補助）
   - 制約: Google OR-Tools CP-SAT
   - データ変換: YOLOアノテーション → JSON (Shapely Polygon + NetworkX Graph)

3. **YOLOの役割再定義**:
   - 間取り生成には直接関与せず、データ準備と評価に特化
   - 教師データ作成支援と生成案の評価補助

### プラン別の特徴

#### プランA
- **特徴**: 簡潔な概要と10日間の短期実装計画
- **強み**: 
  - 明確な初期タスク（5項目）の提示
  - CP-SATとFreeCADの最小サンプルコード提供
  - 意思決定ガイドラインの提示
- **弱み**: 
  - 長期的な実装計画の詳細が少ない
  - コード例が限定的

#### プランB
- **特徴**: 詳細な8週間実装計画と豊富なコード例
- **強み**:
  - 段階的な実装ステップの詳細な説明
  - データ整備、生成、制約、評価の各フェーズの具体的なコード例
  - CP-SAT最小PoCの完全な実装例
  - モジュール分離によるリスク低減戦略
- **弱み**:
  - 実装の複雑さが高い
  - 8週間という比較的長い実装期間

#### プランC
- **特徴**: プランAとBの統合と優先順位の明確化
- **強み**:
  - データ整備とCP-SAT PoCの優先順位を明確化
  - YOLOの役割を明確に定義
  - 実装の現実性と段階的アプローチの強調
- **弱み**:
  - プランB同様の実装複雑性
  - 具体的なコード例が少ない

## 最適プランの選定: プランB

現在の実装状況と将来の要件を考慮し、**プランB**を最適な実装アプローチとして選定します。

### 選定理由

1. **包括的な実装詳細**:
   - 8週間の詳細な実装計画により、開発チームが明確なマイルストーンを持って進められる
   - 各フェーズの具体的なコード例により、実装の不確実性を低減

2. **モジュール分離によるリスク管理**:
   - 生成と制約を完全に分離することで、一方が失敗しても別モジュールで補完可能
   - 段階的な実装と検証アプローチにより、早期に問題を発見可能

3. **CP-SAT最小PoCの完全実装例**:
   - 初期段階で実現可能性を検証できる具体的なコード
   - 910mmグリッド、採光条件、階段寸法などの基本制約の実装例

4. **現在の実装状況との整合性**:
   - 既存のYOLO実装を活かしながら、新たな生成・制約アプローチを段階的に導入
   - FreeCAD APIとの統合が明確に示されている

5. **将来の拡張性**:
   - 評価システムの組み込みにより、生成結果の品質向上が可能
   - 補完的なGraph2Planアプローチの準備により、特定条件下での柔軟性を確保

## 実装ロードマップ（プランBベース）

### フェーズ1: データ整備とCP-SAT PoC（1-2週目）
1. YOLOアノテーション → ベクター/グラフJSON変換システム構築
2. CP-SAT最小PoC開発
   - 3LDKの基本的な間取りを生成・制約遵守を検証
   - 910mmグリッド + 採光条件 + 階段寸法の基本制約を実装

### フェーズ2: HouseDiffusionモデル開発（3-4週目）
1. HouseDiffusion実装・小規模データセットで初期トレーニング
2. 敷地形状と方位条件の埋め込みメカニズム実装
3. FreeCAD出力基本システム構築

### フェーズ3: 制約ソルバー完成と統合（5-6週目）
1. CP-SATソルバーの完全実装
   - 採光、階段、1F/2F整合性など全制約条件の実装
2. Diffusionモデルと制約ソルバーの統合
3. ベンチマークテスト（100案生成→制約チェック→最適化）

### フェーズ4: UI開発と最終調整（7-8週目）
1. Streamlit/Three.js UIの開発
2. 評価システム完成
3. パフォーマンス最適化
4. 実際の敷地データでのエンドツーエンドテスト

## 建築基準法と設計要件への対応

プランBは、以下の設計上絶対に外せない要件に対して、CP-SATソルバーによる明示的な制約として実装することが可能です：

1. **建蔽率**:
   - 敷地面積に対する建築面積の割合を数値制約として実装
   - CP-SATの線形制約として `建築面積 ≤ 敷地面積 × 建蔽率` を定式化

2. **容積率**:
   - 敷地面積に対する延床面積の割合を数値制約として実装
   - CP-SATの線形制約として `延床面積 ≤ 敷地面積 × 容積率` を定式化

3. **要求延床面積**:
   - 指定された延床面積を厳密に満たす制約を実装
   - 許容誤差範囲を設定可能（例: ±1%以内）

4. **延床毎の部屋数**:
   - 延床面積に応じた部屋数の条件分岐を実装
   - 100㎡以上: 4LDK
   - 70㎡~100㎡: 3LDK
   - 70㎡以下: 2LDK

5. **LDKの形状制約**:
   - LDKを長方形の1室として定義する形状制約
   - 矩形性を保証するための座標制約を実装

6. **道路斜線・北側斜線**:
   - 3次元空間内での斜線制約を数学的に定式化
   - 各階の高さと位置に基づく制約条件を実装

7. **各階トイレ配置**:
   - 各階に少なくとも1つのトイレを配置する制約
   - 階層間の接続関係を考慮した配置最適化

8. **採光窓と隣地境界**:
   - 採光窓から隣地境界まで2m以上の距離を確保する制約
   - 窓の配置と方向を考慮した空間制約

9. **建物配置の方向**:
   - 最長の敷地境界線に平行に建物を配置する制約
   - 敷地形状の分析と主軸の抽出アルゴリズムを実装

これらの制約は、CP-SATソルバーの「ハード制約」として実装され、すべての生成結果がこれらの条件を100%満たすことを保証します。プランBの二層アーキテクチャでは、HouseDiffusionが創造的な間取り案を生成した後、CP-SATソルバーがこれらの厳格な制約を適用して法的・技術的要件を満たす最終案を生成します。

## 結論

プランBは、創造性（生成レイヤー）と厳密性（制約レイヤー）のバランスを取りながら、実用的な間取り生成システムを構築するための最も詳細かつ実現可能なアプローチを提供しています。8週間の実装計画は、段階的な開発と検証を可能にし、リスクを最小限に抑えながら目標を達成するための明確なロードマップとなります。特に、建築基準法や設計要件などの厳格な制約を明示的にコード化できる点が、プランBの大きな強みです。
